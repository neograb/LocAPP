{% extends "base.html" %}

{% block title %}Nouvelle Propri√©t√© - LocApp{% endblock %}

{% block extra_head %}
<style>
/* Map container with smooth transitions */
#map-wrapper {
    height: 350px;
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

#map-placeholder {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #64748b;
    transition: opacity 0.4s ease;
    z-index: 2;
}

#map-placeholder.hidden {
    opacity: 0;
    pointer-events: none;
}

#map-placeholder span {
    font-size: 4rem;
    margin-bottom: 1rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

#map {
    width: 100%;
    height: 100%;
}

/* Address input with autocomplete styling */
.address-input-wrapper {
    position: relative;
}

.address-input-wrapper input {
    padding-left: 40px;
}

.address-input-wrapper .input-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
    color: #9ca3af;
    pointer-events: none;
}

/* Google Places Autocomplete dropdown styling */
.pac-container {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    margin-top: 8px;
    font-family: inherit;
    z-index: 10000;
}

.pac-item {
    padding: 12px 16px;
    cursor: pointer;
    border-top: 1px solid #f1f5f9;
    font-size: 0.95rem;
}

.pac-item:first-child {
    border-top: none;
    border-radius: 12px 12px 0 0;
}

.pac-item:last-child {
    border-radius: 0 0 12px 12px;
}

.pac-item:hover {
    background: #f8fafc;
}

.pac-item-selected {
    background: #eff6ff;
}

.pac-icon {
    margin-right: 12px;
}

.pac-item-query {
    font-weight: 600;
    color: #1e293b;
}

/* Loading spinner */
.geocoding-spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid #e5e7eb;
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 6px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Location found badge */
.location-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    color: #047857;
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    margin-top: 8px;
}

.location-badge.error {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    color: #dc2626;
}
</style>
{% endblock %}

{% block content %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <div class="card-header">
        <h2 class="card-title">Cr√©er une nouvelle propri√©t√©</h2>
    </div>

    <!-- Limit Warning Banner -->
    <div id="limitWarning" class="limit-warning" style="display: none;">
        <div class="warning-content">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <div class="warning-text">
                <strong>Limite atteinte</strong>
                <p id="limitMessage">Vous avez atteint la limite de propri√©t√©s pour votre abonnement.</p>
            </div>
            <a href="/account" class="btn btn-primary btn-sm">Changer de plan</a>
        </div>
    </div>

    <form id="newPropertyForm">
        <div class="form-group">
            <label class="form-label" for="property_name">Nom de la propri√©t√© *</label>
            <input type="text" class="form-control" id="property_name" name="name" required
                   placeholder="Ex: Appartement Paris 15, Maison de vacances Bretagne...">
            <small style="color: #6b7280;">Ce nom sera affich√© dans la liste de vos propri√©t√©s</small>
        </div>

        <div class="form-group">
            <label class="form-label" for="property_address">Adresse compl√®te *</label>
            <div class="address-input-wrapper">
                <span class="input-icon">üìç</span>
                <input type="text" class="form-control" id="property_address" name="address" required
                       placeholder="Commencez √† taper une adresse..." autocomplete="off">
            </div>
            <small style="color: #6b7280;">L'autocompl√©tion Google vous aide √† trouver l'adresse exacte</small>
        </div>

        <!-- Map Container -->
        <div class="form-group">
            <label class="form-label">Localisation sur la carte</label>
            <div id="map-wrapper">
                <div id="map-placeholder">
                    <span>üó∫Ô∏è</span>
                    <p style="margin: 0; font-weight: 500;">Recherchez une adresse</p>
                    <p style="margin: 4px 0 0; font-size: 0.85rem; opacity: 0.7;">La carte s'affichera automatiquement</p>
                </div>
                <div id="map"></div>
            </div>
            <div id="geocoding-status"></div>
        </div>

        <!-- Hidden fields for coordinates and location data -->
        <input type="hidden" id="property_lat" name="latitude">
        <input type="hidden" id="property_lng" name="longitude">
        <input type="hidden" id="property_display_name" name="display_name">
        <input type="hidden" id="property_region" name="region">

        <div class="form-group">
            <label class="form-label" for="property_icon">Ic√¥ne (optionnel)</label>
            <select class="form-control" id="property_icon" name="icon">
                <option value="üè†">üè† Maison</option>
                <option value="üè°">üè° Maison avec jardin</option>
                <option value="üè¨">üè¨ Appartement</option>
                <option value="üè¢">üè¢ Immeuble</option>
                <option value="üè®">üè® H√¥tel</option>
                <option value="üèñÔ∏è">üèñÔ∏è Bord de mer</option>
                <option value="üèîÔ∏è">üèîÔ∏è Montagne</option>
                <option value="üå≤">üå≤ Campagne</option>
                <option value="üè∞">üè∞ Ch√¢teau</option>
                <option value="üõñ">üõñ Chalet</option>
            </select>
        </div>

        <div class="creation-options" style="margin-top: 2rem;">
            <div class="creation-option">
                <button type="submit" class="btn btn-primary btn-large" id="submitBtn" disabled>
                    <span>üìã</span> Cr√©er ma propri√©t√©
                </button>
                <p class="option-desc">Cr√©ation bas√©e sur un mod√®le que vous personnaliserez ensuite</p>
            </div>

            <div class="btn-separator">ou</div>

            <div class="creation-option">
                <button type="button" class="btn btn-ai btn-large" id="aiBtn" disabled onclick="generateWithAI()">
                    <span>‚ú®</span> G√©n√©rer avec l'IA
                </button>
                <p class="option-desc">L'IA g√©n√®re automatiquement le contenu bas√© sur l'adresse</p>
            </div>
        </div>
    </form>
</div>

<style>
.btn-ai {
    background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #4f46e5 100%);
    color: white;
    border: none;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.btn-ai:hover:not(:disabled) {
    background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 50%, #4338ca 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
}

.btn-ai:disabled {
    background: linear-gradient(135deg, #a5b4fc 0%, #c4b5fd 100%);
    cursor: not-allowed;
    opacity: 0.7;
}

.btn-ai span { margin-right: 0.5rem; }

.btn-large {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-separator {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: #9ca3af;
    font-size: 0.875rem;
}

.btn-separator::before,
.btn-separator::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #e5e7eb;
}

.creation-options {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.creation-option { text-align: center; }
.creation-option .btn-large { width: 100%; }

.option-desc {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #6b7280;
}

.limit-warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid #f59e0b;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
}

.limit-warning .warning-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.limit-warning .warning-icon {
    font-size: 2rem;
}

.limit-warning .warning-text {
    flex: 1;
    min-width: 200px;
}

.limit-warning .warning-text strong {
    color: #92400e;
    display: block;
    margin-bottom: 0.25rem;
}

.limit-warning .warning-text p {
    margin: 0;
    color: #78350f;
    font-size: 0.9rem;
}

.limit-warning.limit-reached {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border-color: #ef4444;
}

.limit-warning.limit-reached .warning-text strong {
    color: #991b1b;
}

.limit-warning.limit-reached .warning-text p {
    color: #7f1d1d;
}
</style>
{% endblock %}

{% block scripts %}
<!-- Google Maps with Places API -->
<script>
let map = null;
let marker = null;
let autocomplete = null;
const addressInput = document.getElementById('property_address');
const statusEl = document.getElementById('geocoding-status');
const placeholder = document.getElementById('map-placeholder');

// Google Maps API Key - configure in settings
const GOOGLE_MAPS_API_KEY = '{{ config.get("GOOGLE_MAPS_API_KEY", "") }}';

// Load Google Maps API dynamically
function loadGoogleMapsAPI() {
    if (GOOGLE_MAPS_API_KEY) {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=initGoogleMaps&language=fr`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    } else {
        // Fallback to OpenStreetMap if no Google API key
        loadOpenStreetMap();
    }
}

// Initialize Google Maps
function initGoogleMaps() {
    // Initialize map centered on France
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 46.603354, lng: 1.888334 },
        zoom: 5,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
        styles: [
            { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }
        ]
    });

    // Initialize Places Autocomplete
    autocomplete = new google.maps.places.Autocomplete(addressInput, {
        types: ['address'],
        componentRestrictions: { country: 'fr' },
        fields: ['formatted_address', 'geometry', 'address_components', 'name']
    });

    // Bias results to France
    autocomplete.setBounds(new google.maps.LatLngBounds(
        new google.maps.LatLng(41.333, -5.266),
        new google.maps.LatLng(51.124, 9.662)
    ));

    // Handle place selection
    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();

        if (!place.geometry || !place.geometry.location) {
            statusEl.innerHTML = '<div class="location-badge error">‚ùå Adresse non trouv√©e</div>';
            return;
        }

        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();

        // Extract region from address components
        let region = '';
        let city = '';
        if (place.address_components) {
            for (const component of place.address_components) {
                if (component.types.includes('administrative_area_level_2')) {
                    region = component.long_name; // D√©partement
                } else if (component.types.includes('administrative_area_level_1')) {
                    if (!region) region = component.long_name; // R√©gion
                } else if (component.types.includes('locality')) {
                    city = component.long_name;
                }
            }
        }

        // Store values
        document.getElementById('property_lat').value = lat;
        document.getElementById('property_lng').value = lng;
        document.getElementById('property_display_name').value = place.formatted_address;
        document.getElementById('property_region').value = region;

        // Show status
        statusEl.innerHTML = `<div class="location-badge">‚úì ${city ? city + ' ‚Ä¢ ' : ''}${region || 'Localisation trouv√©e'}</div>`;

        // Show on map
        showMapAtLocation(lat, lng, place.formatted_address);
    });
}

// Show map at specific location
function showMapAtLocation(lat, lng, title) {
    placeholder.classList.add('hidden');

    map.setCenter({ lat, lng });
    map.setZoom(16);

    if (marker) {
        marker.setPosition({ lat, lng });
    } else {
        marker = new google.maps.Marker({
            position: { lat, lng },
            map: map,
            animation: google.maps.Animation.DROP,
            title: title
        });
    }

    // Enable buttons
    document.getElementById('submitBtn').disabled = !document.getElementById('property_name').value.trim();
    document.getElementById('aiBtn').disabled = false;
}

// Fallback: OpenStreetMap with Nominatim
function loadOpenStreetMap() {
    // Load Leaflet CSS
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(link);

    // Load Leaflet JS
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload = initLeafletMap;
    document.head.appendChild(script);
}

let leafletMap = null;
let leafletMarker = null;
let geocodingTimeout = null;

function initLeafletMap() {
    leafletMap = L.map('map', {
        center: [46.603354, 1.888334],
        zoom: 5
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap ¬© CartoDB',
        maxZoom: 19
    }).addTo(leafletMap);

    // Use Nominatim for geocoding
    addressInput.addEventListener('input', debounceGeocoding);
}

function debounceGeocoding() {
    clearTimeout(geocodingTimeout);
    const address = addressInput.value.trim();

    if (address.length < 5) {
        statusEl.innerHTML = '';
        return;
    }

    statusEl.innerHTML = '<span class="geocoding-spinner"></span>Recherche...';
    geocodingTimeout = setTimeout(() => geocodeWithNominatim(address), 500);
}

async function geocodeWithNominatim(address) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1&countrycodes=fr`,
            { headers: { 'Accept-Language': 'fr' } }
        );

        const data = await response.json();

        if (data?.length > 0) {
            const { lat, lon, display_name, address: addr } = data[0];

            let region = addr?.county || addr?.state || addr?.department || '';
            let city = addr?.city || addr?.town || addr?.village || '';

            document.getElementById('property_lat').value = lat;
            document.getElementById('property_lng').value = lon;
            document.getElementById('property_display_name').value = display_name;
            document.getElementById('property_region').value = region;

            statusEl.innerHTML = `<div class="location-badge">‚úì ${city ? city + ' ‚Ä¢ ' : ''}${region || 'Localisation trouv√©e'}</div>`;

            showLeafletMap(parseFloat(lat), parseFloat(lon));
        } else {
            statusEl.innerHTML = '<div class="location-badge error">‚ùå Adresse non trouv√©e</div>';
        }
    } catch (e) {
        statusEl.innerHTML = '<div class="location-badge error">‚ùå Erreur de recherche</div>';
    }
}

function showLeafletMap(lat, lng) {
    placeholder.classList.add('hidden');

    leafletMap.setView([lat, lng], 16, { animate: true });

    if (leafletMarker) {
        leafletMarker.setLatLng([lat, lng]);
    } else {
        leafletMarker = L.marker([lat, lng]).addTo(leafletMap);
    }

    setTimeout(() => leafletMap.invalidateSize(), 100);

    document.getElementById('submitBtn').disabled = !document.getElementById('property_name').value.trim();
    document.getElementById('aiBtn').disabled = false;
}

// Property name listener
document.getElementById('property_name').addEventListener('input', function() {
    const hasCoords = document.getElementById('property_lat').value;
    document.getElementById('submitBtn').disabled = !(this.value.trim() && hasCoords);
});

// Form submission
document.getElementById('newPropertyForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('property_name').value.trim();
    const address = addressInput.value.trim();
    const icon = document.getElementById('property_icon').value;
    const lat = document.getElementById('property_lat').value;
    const lng = document.getElementById('property_lng').value;
    const displayName = document.getElementById('property_display_name').value;
    const region = document.getElementById('property_region').value;

    if (!name || !address || !lat || !lng) {
        showAlert('Veuillez remplir tous les champs et valider l\'adresse', 'error');
        return;
    }

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="geocoding-spinner"></span> Cr√©ation...';

    try {
        const response = await fetch('/api/properties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name, address, icon,
                latitude: lat, longitude: lng,
                display_name: displayName, region: region
            })
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('Propri√©t√© cr√©√©e avec succ√®s!', 'success');
            localStorage.setItem('locapp_current_property', result.id);
            setTimeout(() => window.location.href = '/general?property_id=' + result.id, 1000);
        } else {
            showAlert('Erreur: ' + (result.error || '√âchec'), 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>üìã</span> Cr√©er ma propri√©t√©';
        }
    } catch (e) {
        showAlert('Erreur de connexion', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>üìã</span> Cr√©er ma propri√©t√©';
    }
});

// AI Generation
async function generateWithAI() {
    const name = document.getElementById('property_name').value.trim();
    const address = addressInput.value.trim();
    const lat = document.getElementById('property_lat').value;
    const lng = document.getElementById('property_lng').value;
    const displayName = document.getElementById('property_display_name').value;
    const region = document.getElementById('property_region').value;

    if (!name) {
        showAlert('Veuillez saisir un nom pour la propri√©t√©', 'error');
        return;
    }

    if (!address || !lat || !lng) {
        showAlert('Veuillez d\'abord valider une adresse', 'error');
        return;
    }

    const aiBtn = document.getElementById('aiBtn');
    aiBtn.disabled = true;
    aiBtn.innerHTML = '<span class="geocoding-spinner"></span> G√©n√©ration...';

    try {
        const response = await fetch('/api/properties/generate-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name, address, latitude: lat, longitude: lng,
                display_name: displayName, region: region
            })
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('Propri√©t√© g√©n√©r√©e!', 'success');
            localStorage.setItem('locapp_current_property', result.id);
            setTimeout(() => window.location.href = '/general?property_id=' + result.id, 1000);
        } else {
            showAlert('Erreur: ' + (result.error || '√âchec'), 'error');
            aiBtn.disabled = false;
            aiBtn.innerHTML = '<span>‚ú®</span> G√©n√©rer avec l\'IA';
        }
    } catch (e) {
        showAlert('Erreur de connexion', 'error');
        aiBtn.disabled = false;
        aiBtn.innerHTML = '<span>‚ú®</span> G√©n√©rer avec l\'IA';
    }
}

// Check property creation limit
async function checkPropertyLimit() {
    try {
        const response = await fetch('/api/subscription/can-create-property', {
            credentials: 'same-origin'
        });

        if (!response.ok) {
            console.error('Error checking property limit: HTTP ' + response.status);
            return;
        }

        const data = await response.json();

        if (!data.can_create) {
            const warningDiv = document.getElementById('limitWarning');
            const messageP = document.getElementById('limitMessage');
            const form = document.getElementById('newPropertyForm');

            warningDiv.style.display = 'block';
            warningDiv.classList.add('limit-reached');

            const maxText = data.max_properties === -1 ? 'illimit√©es' : data.max_properties;
            messageP.textContent = `Vous avez ${data.current_count}/${maxText} propri√©t√©(s). Passez √† un plan sup√©rieur pour en cr√©er davantage.`;

            // Disable the form
            form.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('aiBtn').disabled = true;
        }
    } catch (error) {
        console.error('Error checking property limit:', error);
    }
}

// Load the appropriate map API
loadGoogleMapsAPI();

// Check property limit on page load
checkPropertyLimit();
</script>
{% endblock %}
