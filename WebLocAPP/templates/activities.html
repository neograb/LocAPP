{% extends "base.html" %}

{% block title %}Activit√©s - Administration LocApp{% endblock %}

{% block content %}
<style>
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .header-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .btn-ai-generate {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #4f46e5 100%);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        transition: all 0.3s ease;
    }
    .btn-ai-generate:hover:not(:disabled) {
        background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 50%, #4338ca 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    .btn-ai-generate:disabled {
        background: #d1d5db;
        color: #9ca3af;
        cursor: not-allowed;
    }
    .btn-ai-generate .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .ai-tooltip { position: relative; }
    .ai-tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        margin-bottom: 0.5rem;
    }
    .ai-tooltip:hover::after { opacity: 1; visibility: visible; }
    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.6rem 1rem;
        background: var(--bg-secondary);
        cursor: grab;
        user-select: none;
    }
    .section-header:active {
        cursor: grabbing;
    }
    .section-header.dragging {
        opacity: 0.5;
    }
    .section-header-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .section-drag-handle {
        color: var(--text-muted);
        cursor: grab;
    }
    .section-icon {
        font-size: 1.2rem;
    }
    .section-name {
        font-weight: 600;
        color: var(--primary-color);
    }
    .section-count {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-left: 0.5rem;
    }
    .section-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .section-content {
        padding: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
    }
    .section-content.expanded {
        max-height: 2000px;
        padding: 0.25rem 1rem 0.75rem 1rem;
    }
    .activity-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: grab;
    }
    .activity-item:active {
        cursor: grabbing;
    }
    .activity-item.dragging {
        opacity: 0.5;
    }
    .activity-drag-handle {
        color: var(--text-muted);
        margin-right: 0.75rem;
        cursor: grab;
    }
    .activity-emoji {
        font-size: 1.25rem;
        margin-right: 0.75rem;
    }
    .activity-info {
        flex: 1;
    }
    .activity-name {
        font-weight: 500;
    }
    .activity-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
    }
    .activity-distance {
        font-size: 0.8rem;
        color: var(--primary-color);
        background: var(--accent-light);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-right: 0.5rem;
    }
    .activity-actions {
        display: flex;
        gap: 0.5rem;
    }
    .btn-icon {
        padding: 0.35rem 0.5rem;
        font-size: 0.85rem;
    }
    .btn-ai-icon {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        border: none;
        color: white;
        padding: 0.35rem 0.5rem;
        font-size: 0.85rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-ai-icon:hover:not(:disabled) {
        background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
        transform: scale(1.05);
    }
    .btn-ai-icon.loading {
        pointer-events: none;
        opacity: 0.7;
    }
    .btn-ai-icon .spinner-small {
        width: 12px;
        height: 12px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
    }
    .add-activity-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: var(--bg-secondary);
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }
    .add-activity-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    .chevron {
        transition: transform 0.3s;
        cursor: pointer;
    }
    .chevron.expanded {
        transform: rotate(180deg);
    }
    .drop-zone {
        min-height: 50px;
        border: 2px dashed transparent;
        border-radius: 8px;
        transition: all 0.2s;
    }
    .drop-zone.drag-over {
        border-color: var(--primary-color);
        background: rgba(var(--primary-rgb), 0.05);
    }
    .new-category-input {
        display: none;
        margin-top: 0.5rem;
    }
    .new-category-input.visible {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }
    .new-category-input > input:first-of-type {
        flex: 1;
        min-width: 150px;
    }
</style>

<div class="admin-layout">
    <div class="admin-form-section">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Gestion des Activit√©s</h2>
                <div class="header-buttons">
                    {% if has_ai_access %}
                    <button type="button" class="btn-ai-generate" id="btnAiGenerate" onclick="regenerateWithAI()">
                        <span>‚ú®</span> R√©g√©n√©rer avec l'IA
                    </button>
                    {% else %}
                    <button type="button" class="btn-ai-generate ai-tooltip" disabled data-tooltip="Fonctionnalit√© r√©serv√©e aux abonn√©s">
                        <span>‚ú®</span> R√©g√©n√©rer avec l'IA
                    </button>
                    {% endif %}
                    <button class="btn btn-primary" onclick="openAddModal()">+ Ajouter</button>
                </div>
            </div>

            <div id="sectionsContainer">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <div class="admin-preview-section">
        <p class="preview-title">Aper√ßu mobile - Activit√©s</p>
        <div class="mini-iphone">
            <div class="iphone-notch"></div>
            <div class="iphone-screen">
                <div class="status-bar">
                    <span>Activit√©s</span>
                </div>
                <div class="app-content">
                    <div class="preview-content">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <strong style="font-size: 12px;">D√©couvrez la r√©gion</strong>
                            <p style="font-size: 8px; color: #6b7280;">Nos recommandations</p>
                        </div>
                        <div id="preview-activities"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Add/Edit Activity -->
<div id="activityModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Ajouter une activit√©</h3>
            <button class="modal-close" onclick="closeModal('activityModal')">&times;</button>
        </div>

        <form id="activityForm">
            <input type="hidden" id="activity_id" name="id">

            <div class="form-group">
                <label class="form-label" for="name">Nom de l'activit√©</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="category">Section</label>
                <select class="form-control" id="category" name="category" required>
                    <option value="">Choisir ou cr√©er une section...</option>
                </select>
                <div class="new-category-input" id="newCategoryInput">
                    <input type="text" class="form-control" id="newCategoryName" placeholder="Nom de la section">
                    <div class="emoji-input-wrapper" style="flex-shrink: 0;">
                        <input type="text" class="form-control emoji-input" id="newCategoryIcon" readonly style="width: 50px; text-align: center;">
                        <button type="button" class="emoji-trigger" onclick="openEmojiPicker('newCategoryIcon', this)">üìç</button>
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" onclick="createCategoryInline()">Cr√©er</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="description">Description</label>
                <textarea class="form-control" id="description" name="description" rows="2"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label" for="emoji">Emoji</label>
                    <div class="emoji-input-wrapper">
                        <input type="text" class="form-control emoji-input" id="emoji" name="emoji" readonly placeholder="Choisir">
                        <button type="button" class="emoji-trigger" onclick="openEmojiPicker('emoji', this)">üèûÔ∏è</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="distance">Distance</label>
                    <input type="text" class="form-control" id="distance" name="distance" placeholder="15 min">
                </div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('activityModal')">Annuler</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal for Add/Edit Category -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="categoryModalTitle">Nouvelle section</h3>
            <button class="modal-close" onclick="closeModal('categoryModal')">&times;</button>
        </div>

        <form id="categoryForm">
            <input type="hidden" id="category_id" name="id">

            <div class="form-group">
                <label class="form-label" for="cat_name">Nom de la section</label>
                <input type="text" class="form-control" id="cat_name" name="name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="cat_icon">Ic√¥ne</label>
                <div class="emoji-input-wrapper">
                    <input type="text" class="form-control emoji-input" id="cat_icon" name="icon" readonly placeholder="Choisir">
                    <button type="button" class="emoji-trigger" onclick="openEmojiPicker('cat_icon', this)">üìç</button>
                </div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('categoryModal')">Annuler</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/emoji-picker.js') }}"></script>
<script>
let activities = [];
let categories = [];

// Load data
async function loadCategories() {
    try {
        const propertyId = getCurrentPropertyId();
        categories = await fetchAPI(`/api/activity-categories?property_id=${propertyId}`);
        updateCategorySelect();
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function updateCategorySelect() {
    const categorySelect = document.getElementById('category');
    categorySelect.innerHTML = '<option value="">S√©lectionnez une section</option>';
    categories.forEach(cat => {
        categorySelect.innerHTML += `<option value="${cat.name}">${cat.icon || 'üìç'} ${cat.name}</option>`;
    });
    categorySelect.innerHTML += '<option value="__new__">+ Cr√©er une nouvelle section...</option>';
}

document.getElementById('category').addEventListener('change', function() {
    const newCatInput = document.getElementById('newCategoryInput');
    if (this.value === '__new__') {
        newCatInput.classList.add('visible');
    } else {
        newCatInput.classList.remove('visible');
    }
});

async function createCategoryInline() {
    const name = document.getElementById('newCategoryName').value.trim();
    if (!name) {
        showAlert('Entrez un nom de section', 'error');
        return;
    }

    const icon = document.getElementById('newCategoryIcon').value || 'üìç';
    const propertyId = getCurrentPropertyId();
    try {
        const response = await fetch(`/api/activity-categories?property_id=${propertyId}`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({ name, icon })
        });
        if (response.ok) {
            await loadCategories();
            document.getElementById('category').value = name;
            document.getElementById('newCategoryInput').classList.remove('visible');
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryIcon').value = '';
            // Reset emoji picker button
            const emojiTrigger = document.querySelector('#newCategoryInput .emoji-trigger');
            if (emojiTrigger) emojiTrigger.textContent = 'üìç';
            showAlert('Section cr√©√©e', 'success');
        }
    } catch (error) {
        showAlert('Erreur lors de la cr√©ation', 'error');
    }
}

async function loadActivities() {
    try {
        activities = await fetchAPI('/api/activities');
        renderSections();
        updatePreview();
    } catch (error) {
        showAlert('Erreur lors du chargement', 'error');
    }
}

function renderSections() {
    const container = document.getElementById('sectionsContainer');

    if (categories.length === 0 && activities.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üéØ</div>
                <div class="empty-state-text">Aucune activit√©</div>
                <p style="color: var(--text-muted);">Cliquez sur "+ Ajouter" pour commencer</p>
            </div>
        `;
        return;
    }

    // Group activities by category
    const grouped = {};
    activities.forEach(a => {
        if (!grouped[a.category]) grouped[a.category] = [];
        grouped[a.category].push(a);
    });

    // Sort activities within each category by display_order
    Object.keys(grouped).forEach(cat => {
        grouped[cat].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
    });

    let html = '';
    categories.forEach(cat => {
        const catActivities = grouped[cat.name] || [];
        const icon = cat.icon || 'üìç';

        html += `
            <div class="section-card" data-category-id="${cat.id}" data-category-name="${cat.name}" draggable="true">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-header-left">
                        <span class="section-drag-handle">‚ãÆ‚ãÆ</span>
                        <span class="section-icon">${icon}</span>
                        <span class="section-name">${cat.name}</span>
                        <span class="section-count">(${catActivities.length})</span>
                    </div>
                    <div class="section-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-sm btn-icon btn-secondary" onclick="editCategory(${cat.id})" title="Modifier">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-icon btn-danger" onclick="deleteCategory(${cat.id})" title="Supprimer">üóëÔ∏è</button>
                        <span class="chevron">‚ñº</span>
                    </div>
                </div>
                <div class="section-content" data-category="${cat.name}">
                    <div class="drop-zone" data-category="${cat.name}">
                        ${catActivities.map(a => renderActivityItem(a)).join('')}
                        <div class="add-activity-btn" data-category="${cat.name.replace(/"/g, '&quot;')}" onclick="openAddModalForCategory(this.dataset.category)">
                            <span>+</span> Ajouter une activit√©
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    initDragAndDrop();
}

function renderActivityItem(activity) {
    const hasAiAccess = {{ 'true' if has_ai_access else 'false' }};
    const aiButton = hasAiAccess
        ? `<button class="btn btn-sm btn-icon btn-ai-icon" onclick="regenerateActivity(${activity.id})" title="R√©g√©n√©rer avec l'IA">‚ú®</button>`
        : `<button class="btn btn-sm btn-icon btn-ai-icon" disabled title="Fonctionnalit√© r√©serv√©e aux abonn√©s" style="opacity: 0.4; cursor: not-allowed;">‚ú®</button>`;

    return `
        <div class="activity-item" data-activity-id="${activity.id}" draggable="true">
            <span class="activity-drag-handle">‚ãÆ‚ãÆ</span>
            <span class="activity-emoji">${activity.emoji || 'üìç'}</span>
            <div class="activity-info">
                <div class="activity-name">${activity.name}</div>
                <div class="activity-desc">${activity.description || ''}</div>
            </div>
            ${activity.distance ? `<span class="activity-distance">${activity.distance}</span>` : ''}
            <div class="activity-actions">
                ${aiButton}
                <button class="btn btn-sm btn-icon btn-secondary" onclick="editActivity(${activity.id})" title="Modifier">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-icon btn-danger" onclick="deleteActivity(${activity.id})" title="Supprimer">üóëÔ∏è</button>
            </div>
        </div>
    `;
}

function toggleSection(header) {
    const content = header.nextElementSibling;
    const chevron = header.querySelector('.chevron');
    content.classList.toggle('expanded');
    chevron.classList.toggle('expanded');
}

// Drag and Drop
function initDragAndDrop() {
    // Section drag and drop
    const sections = document.querySelectorAll('.section-card');
    sections.forEach(section => {
        section.addEventListener('dragstart', handleSectionDragStart);
        section.addEventListener('dragend', handleSectionDragEnd);
        section.addEventListener('dragover', handleSectionDragOver);
        section.addEventListener('drop', handleSectionDrop);
    });

    // Activity drag and drop
    const activityItems = document.querySelectorAll('.activity-item');
    activityItems.forEach(item => {
        item.addEventListener('dragstart', handleActivityDragStart);
        item.addEventListener('dragend', handleActivityDragEnd);
    });

    const dropZones = document.querySelectorAll('.drop-zone');
    dropZones.forEach(zone => {
        zone.addEventListener('dragover', handleActivityDragOver);
        zone.addEventListener('dragleave', handleActivityDragLeave);
        zone.addEventListener('drop', handleActivityDrop);
    });
}

let draggedSection = null;
let draggedActivity = null;

function handleSectionDragStart(e) {
    draggedSection = this;
    this.querySelector('.section-header').classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleSectionDragEnd(e) {
    this.querySelector('.section-header').classList.remove('dragging');
    draggedSection = null;
}

function handleSectionDragOver(e) {
    e.preventDefault();
    if (!draggedSection || draggedSection === this) return;

    const container = document.getElementById('sectionsContainer');
    const sections = [...container.querySelectorAll('.section-card')];
    const currentIndex = sections.indexOf(this);
    const draggedIndex = sections.indexOf(draggedSection);

    if (currentIndex !== draggedIndex) {
        if (currentIndex < draggedIndex) {
            container.insertBefore(draggedSection, this);
        } else {
            container.insertBefore(draggedSection, this.nextSibling);
        }
    }
}

function handleSectionDrop(e) {
    e.preventDefault();
    saveSectionOrder();
}

async function saveSectionOrder() {
    const sections = document.querySelectorAll('.section-card');
    const categoryIds = [...sections].map(s => parseInt(s.dataset.categoryId));

    const propertyId = getCurrentPropertyId();
    try {
        await fetch(`/api/activity-categories/reorder?property_id=${propertyId}`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({ category_ids: categoryIds })
        });
    } catch (error) {
        console.error('Error saving order:', error);
    }
}

function handleActivityDragStart(e) {
    draggedActivity = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.stopPropagation();
}

function handleActivityDragEnd(e) {
    this.classList.remove('dragging');
    draggedActivity = null;
}

function handleActivityDragOver(e) {
    e.preventDefault();
    if (!draggedActivity) return;
    this.classList.add('drag-over');
}

function handleActivityDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleActivityDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    this.classList.remove('drag-over');

    if (!draggedActivity) return;

    const category = this.dataset.category;
    const addBtn = this.querySelector('.add-activity-btn');

    // Insert before the add button
    this.insertBefore(draggedActivity, addBtn);

    // Save the new order
    saveActivityOrder(category);
}

async function saveActivityOrder(category) {
    const zone = document.querySelector(`.drop-zone[data-category="${category}"]`);
    const items = zone.querySelectorAll('.activity-item');
    const activityIds = [...items].map(item => parseInt(item.dataset.activityId));

    const propertyId = getCurrentPropertyId();
    try {
        await fetch(`/api/activities/reorder?property_id=${propertyId}`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({ category, activity_ids: activityIds })
        });
    } catch (error) {
        console.error('Error saving activity order:', error);
    }
}

// Preview
function updatePreview() {
    const previewContainer = document.getElementById('preview-activities');

    const grouped = {};
    activities.forEach(a => {
        if (!grouped[a.category]) grouped[a.category] = [];
        grouped[a.category].push(a);
    });

    let html = '';
    categories.slice(0, 3).forEach(cat => {
        const items = (grouped[cat.name] || []).slice(0, 3);
        if (items.length === 0) return;

        html += `
            <div class="preview-card">
                <div class="preview-card-header">
                    <span>${cat.icon || 'üìç'}</span>
                    <strong>${cat.name}</strong>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;">
                    ${items.map(a => `<span style="font-size: 8px; background: #f3f4f6; padding: 2px 6px; border-radius: 8px;">${a.name}</span>`).join('')}
                </div>
            </div>
        `;
    });

    previewContainer.innerHTML = html || '<p style="text-align: center; color: #9ca3af; font-size: 10px;">Aucune activit√©</p>';
}

// Modal functions
function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Ajouter une activit√©';
    document.getElementById('activityForm').reset();
    document.getElementById('activity_id').value = '';
    document.getElementById('newCategoryInput').classList.remove('visible');
    const emojiTrigger = document.querySelector('#activityForm .emoji-trigger');
    if (emojiTrigger) emojiTrigger.textContent = 'üèûÔ∏è';
    openModal('activityModal');
}

function openAddModalForCategory(categoryName) {
    openAddModal();
    document.getElementById('category').value = categoryName;
}

async function editActivity(id) {
    const activity = activities.find(a => a.id === id);
    if (!activity) return;

    document.getElementById('modalTitle').textContent = 'Modifier l\'activit√©';
    document.getElementById('activity_id').value = activity.id;
    loadDataIntoForm(activity, 'activityForm');

    const emojiTrigger = document.querySelector('#activityForm .emoji-trigger');
    if (emojiTrigger && activity.emoji) emojiTrigger.textContent = activity.emoji;

    openModal('activityModal');
}

async function deleteActivity(id) {
    if (!confirmAction('Supprimer cette activit√© ?')) return;

    try {
        const response = await fetch(`/api/activities/${id}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        if (response.ok) {
            showAlert('Activit√© supprim√©e', 'success');
            loadActivities();
        }
    } catch (error) {
        showAlert('Erreur', 'error');
    }
}

function openCategoryModal() {
    document.getElementById('categoryModalTitle').textContent = 'Nouvelle section';
    document.getElementById('categoryForm').reset();
    document.getElementById('category_id').value = '';
    const emojiTrigger = document.querySelector('#categoryForm .emoji-trigger');
    if (emojiTrigger) emojiTrigger.textContent = 'üìç';
    openModal('categoryModal');
}

async function editCategory(id) {
    const cat = categories.find(c => c.id === id);
    if (!cat) return;

    document.getElementById('categoryModalTitle').textContent = 'Modifier la section';
    document.getElementById('category_id').value = cat.id;
    document.getElementById('cat_name').value = cat.name;
    document.getElementById('cat_icon').value = cat.icon || '';
    const emojiTrigger = document.querySelector('#categoryForm .emoji-trigger');
    if (emojiTrigger) emojiTrigger.textContent = cat.icon || 'üìç';

    openModal('categoryModal');
}

async function deleteCategory(id) {
    const cat = categories.find(c => c.id === id);
    if (!cat) return;

    if (!confirmAction(`Supprimer la section "${cat.name}" et toutes ses activit√©s ?`)) return;

    try {
        const response = await fetch(`/api/activity-categories/${id}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        if (response.ok) {
            showAlert('Section supprim√©e', 'success');
            loadCategories().then(() => loadActivities());
        }
    } catch (error) {
        showAlert('Erreur', 'error');
    }
}

// Form submissions
document.getElementById('activityForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = getFormData('activityForm');
    const activityId = document.getElementById('activity_id').value;
    const propertyId = getCurrentPropertyId();

    // Si l'utilisateur a s√©lectionn√© "Cr√©er une nouvelle section" mais n'a pas cliqu√© sur Cr√©er
    if (formData.category === '__new__') {
        const newCatName = document.getElementById('newCategoryName').value.trim();
        if (!newCatName) {
            showAlert('Veuillez cr√©er la section avant d\'enregistrer', 'error');
            return;
        }
        // Cr√©er la section automatiquement
        const icon = document.getElementById('newCategoryIcon').value || 'üìç';
        try {
            const catResponse = await fetch(`/api/activity-categories?property_id=${propertyId}`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ name: newCatName, icon })
            });
            if (catResponse.ok) {
                formData.category = newCatName;
                await loadCategories();
            } else {
                showAlert('Erreur lors de la cr√©ation de la section', 'error');
                return;
            }
        } catch (error) {
            showAlert('Erreur lors de la cr√©ation de la section', 'error');
            return;
        }
    }

    const url = activityId
        ? `/api/activities/${activityId}?property_id=${propertyId}`
        : `/api/activities?property_id=${propertyId}`;

    try {
        const response = await fetch(url, {
            method: activityId ? 'PUT' : 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            showAlert(activityId ? 'Activit√© modifi√©e' : 'Activit√© cr√©√©e', 'success');
            closeModal('activityModal');
            // Nettoyer les champs de cr√©ation de section
            document.getElementById('newCategoryInput').classList.remove('visible');
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryIcon').value = '';
            // Recharger les cat√©gories puis les activit√©s pour afficher les nouvelles sections
            loadCategories().then(() => loadActivities());
        } else {
            const result = await response.json();
            showAlert('Erreur: ' + (result.error || '√âchec'), 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    }
});

document.getElementById('categoryForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const categoryId = document.getElementById('category_id').value;
    const propertyId = getCurrentPropertyId();
    const data = {
        name: document.getElementById('cat_name').value,
        icon: document.getElementById('cat_icon').value || 'üìç'
    };

    const url = categoryId
        ? `/api/activity-categories/${categoryId}?property_id=${propertyId}`
        : `/api/activity-categories?property_id=${propertyId}`;

    try {
        const response = await fetch(url, {
            method: categoryId ? 'PUT' : 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify(data)
        });

        if (response.ok) {
            showAlert(categoryId ? 'Section modifi√©e' : 'Section cr√©√©e', 'success');
            closeModal('categoryModal');
            loadCategories().then(() => loadActivities());
        } else {
            const result = await response.json();
            showAlert('Erreur: ' + (result.error || '√âchec'), 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    }
});

// AI Regeneration
async function regenerateWithAI() {
    if (!confirmAction('R√©g√©n√©rer toutes les activit√©s avec l\'IA ? Les activit√©s existantes seront remplac√©es.')) return;

    const btn = document.getElementById('btnAiGenerate');
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> G√©n√©ration...';

    try {
        const response = await fetch('/api/ai/regenerate/activities', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Property-ID': localStorage.getItem('locapp_current_property')
            }
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('Activit√©s r√©g√©n√©r√©es avec succ√®s !', 'success');
            loadCategories().then(() => loadActivities());
        } else {
            showAlert(result.error || 'Erreur lors de la r√©g√©n√©ration', 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
    }
}

// Single activity regeneration
async function regenerateActivity(activityId) {
    const activityItem = document.querySelector(`.activity-item[data-activity-id="${activityId}"]`);
    if (!activityItem) return;

    const btn = activityItem.querySelector('.btn-ai-icon');
    if (!btn || btn.classList.contains('loading')) return;

    const originalContent = btn.innerHTML;
    btn.classList.add('loading');
    btn.innerHTML = '<span class="spinner-small"></span>';

    try {
        const response = await fetch(`/api/ai/regenerate/activity/${activityId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Property-ID': localStorage.getItem('locapp_current_property')
            }
        });

        const result = await response.json();

        if (response.ok && result.activity) {
            // Update the activity in our local array
            const idx = activities.findIndex(a => a.id === activityId);
            if (idx !== -1) {
                activities[idx] = { ...activities[idx], ...result.activity };
            }

            // Update only this activity item in the DOM (keep sections expanded)
            const updatedActivity = activities[idx];
            const emojiEl = activityItem.querySelector('.activity-emoji');
            const nameEl = activityItem.querySelector('.activity-name');
            const descEl = activityItem.querySelector('.activity-desc');

            if (emojiEl) emojiEl.textContent = updatedActivity.emoji || 'üìç';
            if (nameEl) nameEl.textContent = updatedActivity.name;
            if (descEl) descEl.textContent = updatedActivity.description || '';

            // Update only the preview
            updatePreview();

            showAlert('Activit√© r√©g√©n√©r√©e avec succ√®s !', 'success');
        } else {
            showAlert(result.error || 'Erreur lors de la r√©g√©n√©ration', 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    } finally {
        // Reset button state
        btn.classList.remove('loading');
        btn.innerHTML = originalContent;
    }
}

// Initialize
loadCategories().then(() => loadActivities());
</script>
{% endblock %}
