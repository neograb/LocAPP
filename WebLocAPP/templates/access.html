{% extends "base.html" %}

{% block title %}Acc√®s & Cl√©s - Administration LocApp{% endblock %}

{% block content %}
<div class="admin-layout">
    <div class="admin-form-section">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Cl√©s & Acc√®s</h2>
            </div>

            <form id="accessForm">
                <div class="form-group">
                    <label class="form-label" for="check_in_time">Heure de check-in</label>
                    <input type="time" class="form-control" id="check_in_time" name="check_in_time" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="check_out_time">Heure de check-out</label>
                    <input type="time" class="form-control" id="check_out_time" name="check_out_time" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="keybox_code">Code de la bo√Æte √† cl√©s</label>
                    <input type="text" class="form-control" id="keybox_code" name="keybox_code" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="keybox_location">Emplacement de la bo√Æte √† cl√©s</label>
                    <textarea class="form-control" id="keybox_location" name="keybox_location" rows="2" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="access_instructions">Instructions d'acc√®s</label>
                    <textarea class="form-control" id="access_instructions" name="access_instructions" rows="3" required></textarea>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" onclick="loadData()">Annuler</button>
                </div>
            </form>

            <div class="info-box" style="margin-top: 2rem;">
                <strong>Derni√®re modification:</strong> <span id="lastUpdate">-</span>
            </div>

            <!-- Section Photos d'acc√®s -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <h3 style="color: var(--primary-color); margin-bottom: 1rem;">üì∑ Photos d'aide √† l'acc√®s</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                    Ajoutez des photos pour aider vos locataires √† trouver l'entr√©e, la bo√Æte √† cl√©s, etc.
                    <span id="photoLimitInfo" style="font-weight: 500;"></span>
                </p>

                <!-- Zone d'upload compacte -->
                <div class="access-upload-zone" id="accessUploadZone">
                    <span>üì∑</span>
                    <p>Glissez-d√©posez ou cliquez pour ajouter des photos</p>
                    <input type="file" id="accessFileInput" multiple accept="image/*" style="display: none;">
                </div>

                <!-- Barre de progression -->
                <div class="access-upload-progress" id="accessUploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="accessProgressFill"></div>
                    </div>
                    <span id="accessProgressText">Upload en cours...</span>
                </div>

                <!-- Galerie photos acc√®s -->
                <div class="access-photos-gallery" id="accessPhotosGallery"></div>
            </div>
        </div>
    </div>

    <div class="admin-preview-section">
        <p class="preview-title">Aper√ßu mobile - Acc√®s</p>
        <div class="mini-iphone">
            <div class="iphone-notch"></div>
            <div class="iphone-screen">
                <div class="status-bar">
                    <span>Infos Pratiques</span>
                </div>
                <div class="app-content">
                    <div class="preview-content">
                        <div class="preview-section-title">Horaires</div>
                        <div class="preview-card">
                            <div class="preview-row">
                                <span class="preview-row-icon">üõ¨</span>
                                <div class="preview-row-content">
                                    <strong>Check-in</strong>
                                    <small>√Ä partir de <span id="preview-checkin">16:00</span></small>
                                </div>
                            </div>
                            <div class="preview-row">
                                <span class="preview-row-icon">üõ´</span>
                                <div class="preview-row-content">
                                    <strong>Check-out</strong>
                                    <small>Avant <span id="preview-checkout">10:00</span></small>
                                </div>
                            </div>
                        </div>

                        <div class="preview-section-title">Bo√Æte √† cl√©s</div>
                        <div class="preview-card" style="background: #fef3c7;">
                            <div class="preview-card-header">
                                <span>üîê</span>
                                <strong>Code d'acc√®s</strong>
                            </div>
                            <p style="text-align: center; font-size: 24px; font-weight: bold; color: #92400e; padding: 8px 0;" id="preview-code">1012</p>
                        </div>

                        <div class="preview-card">
                            <div class="preview-card-header">
                                <span>üìç</span>
                                <strong>Emplacement</strong>
                            </div>
                            <p id="preview-location">La bo√Æte √† cl√©s se trouve √† l'entr√©e principale.</p>
                        </div>

                        <div class="preview-card" style="background: #eff6ff;">
                            <div class="preview-card-header">
                                <span>üìù</span>
                                <strong>Instructions</strong>
                            </div>
                            <p id="preview-instructions">Utilisez ce code pour l'ouvrir et r√©cup√©rer les cl√©s...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
.access-upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
    background: var(--card-bg);
}

.access-upload-zone:hover,
.access-upload-zone.dragover {
    border-color: var(--primary-color);
    background: rgba(var(--primary-rgb), 0.05);
}

.access-upload-zone span {
    font-size: 2rem;
    display: block;
    margin-bottom: 0.5rem;
}

.access-upload-zone p {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin: 0;
}

.access-upload-zone.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.access-upload-progress {
    margin-bottom: 1rem;
}

.access-upload-progress .progress-bar {
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.access-upload-progress .progress-fill {
    height: 100%;
    background: var(--primary-color);
    width: 0%;
    transition: width 0.3s ease;
}

.access-photos-gallery {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
}

.access-photo-card {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

.access-photo-card img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    display: block;
}

.access-photo-card .photo-actions {
    position: absolute;
    top: 4px;
    right: 4px;
    display: flex;
    gap: 4px;
}

.access-photo-card .btn-delete-photo {
    background: rgba(231, 76, 60, 0.9);
    color: white;
    border: none;
    border-radius: 4px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.access-photo-card .btn-delete-photo:hover {
    background: #c0392b;
}

.access-empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}
</style>
{% endblock %}

{% block scripts %}
<script>
function updatePreview() {
    document.getElementById('preview-checkin').textContent = document.getElementById('check_in_time').value || '16:00';
    document.getElementById('preview-checkout').textContent = document.getElementById('check_out_time').value || '10:00';
    document.getElementById('preview-code').textContent = document.getElementById('keybox_code').value || '****';
    document.getElementById('preview-location').textContent = document.getElementById('keybox_location').value || '';
    document.getElementById('preview-instructions').textContent = document.getElementById('access_instructions').value || '';
}

document.querySelectorAll('#accessForm input, #accessForm textarea').forEach(input => {
    input.addEventListener('input', updatePreview);
});

async function loadData() {
    try {
        const data = await fetchAPI('/api/access');
        loadDataIntoForm(data, 'accessForm');
        document.getElementById('lastUpdate').textContent = formatDate(data.updated_at);
        updatePreview();
    } catch (error) {
        showAlert('Erreur lors du chargement des donn√©es', 'error');
    }
}

document.getElementById('accessForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const headers = getAuthHeaders();
    if (!headers) return;

    const formData = getFormData('accessForm');

    try {
        const propertyId = getCurrentPropertyId();
        const response = await fetch(`/api/access?property_id=${propertyId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message, 'success');
            loadData();
        } else {
            showAlert('Erreur: ' + (result.error || '√âchec de la mise √† jour'), 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    }
});

loadData();

// ============================================
// Access Photos Management
// ============================================

const accessUploadZone = document.getElementById('accessUploadZone');
const accessFileInput = document.getElementById('accessFileInput');
let maxAccessPhotos = 3;
let currentAccessPhotosCount = 0;

accessUploadZone.addEventListener('click', () => {
    if (currentAccessPhotosCount < maxAccessPhotos) {
        accessFileInput.click();
    }
});

accessUploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    if (currentAccessPhotosCount < maxAccessPhotos) {
        accessUploadZone.classList.add('dragover');
    }
});

accessUploadZone.addEventListener('dragleave', () => {
    accessUploadZone.classList.remove('dragover');
});

accessUploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    accessUploadZone.classList.remove('dragover');
    if (currentAccessPhotosCount < maxAccessPhotos) {
        handleAccessFiles(e.dataTransfer.files);
    }
});

accessFileInput.addEventListener('change', (e) => {
    handleAccessFiles(e.target.files);
});

async function handleAccessFiles(files) {
    const propertyId = getCurrentPropertyId();
    if (!propertyId) {
        showAlert('Veuillez s√©lectionner une propri√©t√©', 'error');
        return;
    }

    const remaining = maxAccessPhotos - currentAccessPhotosCount;
    if (files.length > remaining) {
        showAlert(`Vous ne pouvez ajouter que ${remaining} photo(s) suppl√©mentaire(s)`, 'error');
        return;
    }

    const uploadProgress = document.getElementById('accessUploadProgress');
    const progressFill = document.getElementById('accessProgressFill');
    const progressText = document.getElementById('accessProgressText');

    uploadProgress.style.display = 'block';

    for (let i = 0; i < files.length; i++) {
        const file = files[i];

        if (!file.type.startsWith('image/')) {
            showAlert(`${file.name} n'est pas une image`, 'error');
            continue;
        }

        progressText.textContent = `Upload de ${file.name} (${i + 1}/${files.length})...`;
        progressFill.style.width = `${((i) / files.length) * 100}%`;

        const formData = new FormData();
        formData.append('photo', file);

        try {
            const response = await fetch(`/api/access-photos?property_id=${propertyId}`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (!response.ok) {
                showAlert(`Erreur: ${result.error}`, 'error');
            }
        } catch (error) {
            showAlert(`Erreur lors de l'upload de ${file.name}`, 'error');
        }

        progressFill.style.width = `${((i + 1) / files.length) * 100}%`;
    }

    uploadProgress.style.display = 'none';
    progressFill.style.width = '0%';
    accessFileInput.value = '';

    showAlert('Photos upload√©es avec succ√®s', 'success');
    loadAccessPhotos();
}

async function loadAccessPhotos() {
    const gallery = document.getElementById('accessPhotosGallery');
    const limitInfo = document.getElementById('photoLimitInfo');

    try {
        // Get limit info
        const limitResponse = await fetchAPI('/api/access-photos/limit');
        maxAccessPhotos = limitResponse.max;
        currentAccessPhotosCount = limitResponse.current;

        limitInfo.textContent = `(${currentAccessPhotosCount}/${maxAccessPhotos})`;

        // Update upload zone state
        if (currentAccessPhotosCount >= maxAccessPhotos) {
            accessUploadZone.classList.add('disabled');
            accessUploadZone.querySelector('p').textContent = 'Limite de photos atteinte';
        } else {
            accessUploadZone.classList.remove('disabled');
            accessUploadZone.querySelector('p').textContent = 'Glissez-d√©posez ou cliquez pour ajouter des photos';
        }

        // Get photos
        const photos = await fetchAPI('/api/access-photos');

        if (!photos || photos.length === 0) {
            gallery.innerHTML = `
                <div class="access-empty-state">
                    <span style="font-size: 2rem;">üì∑</span>
                    <p>Aucune photo d'acc√®s</p>
                </div>
            `;
            return;
        }

        gallery.innerHTML = photos.map(photo => `
            <div class="access-photo-card" data-id="${photo.id}">
                <img src="/static/uploads/${photo.filename}" alt="${photo.title || 'Photo acc√®s'}">
                <div class="photo-actions">
                    <button class="btn-delete-photo" onclick="deleteAccessPhoto(${photo.id})" title="Supprimer">‚úï</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        gallery.innerHTML = '<p class="access-empty-state">Erreur lors du chargement</p>';
    }
}

async function deleteAccessPhoto(photoId) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette photo ?')) return;

    const propertyId = getCurrentPropertyId();

    try {
        const response = await fetch(`/api/access-photos/${photoId}?property_id=${propertyId}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('Photo supprim√©e', 'success');
            loadAccessPhotos();
        } else {
            showAlert(`Erreur: ${result.error}`, 'error');
        }
    } catch (error) {
        showAlert('Erreur lors de la suppression', 'error');
    }
}

// Load access photos on page load
loadAccessPhotos();
</script>
{% endblock %}
