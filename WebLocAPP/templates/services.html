{% extends "base.html" %}

{% block title %}Services - Administration LocApp{% endblock %}

{% block content %}
<style>
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .header-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .btn-ai-generate {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #4f46e5 100%);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        transition: all 0.3s ease;
    }
    .btn-ai-generate:hover:not(:disabled) {
        background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 50%, #4338ca 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    .btn-ai-generate:disabled {
        background: #d1d5db;
        color: #9ca3af;
        cursor: not-allowed;
    }
    .btn-ai-generate .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .btn-icon {
        padding: 0.35rem 0.5rem;
        font-size: 0.85rem;
    }
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }
    .ai-tooltip { position: relative; }
    .ai-tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        margin-bottom: 0.5rem;
    }
    .ai-tooltip:hover::after { opacity: 1; visibility: visible; }
    .category-row {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
    }
    .category-row .form-control {
        flex: 1;
    }
    .btn-ai-search {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #4f46e5 100%);
        color: white;
        border: none;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        transition: all 0.3s ease;
        white-space: nowrap;
        height: 38px;
    }
    .btn-ai-search:hover:not(:disabled) {
        background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 50%, #4338ca 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    .btn-ai-search:disabled {
        background: #d1d5db;
        color: #9ca3af;
        cursor: not-allowed;
    }
    .btn-ai-search .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    /* Drag and Drop styles */
    .drag-handle {
        cursor: grab;
        color: #9ca3af;
        font-size: 1rem;
        padding: 0 0.5rem;
        user-select: none;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
    .table tr.dragging {
        opacity: 0.5;
        background: #e0e7ff;
    }
    .table tr.drag-over {
        border-top: 2px solid #6366f1;
    }
    .table tr {
        transition: background-color 0.2s;
    }
</style>

<div class="admin-layout">
    <div class="admin-form-section">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Services √† proximit√©</h2>
                <div class="header-buttons">
                    {% if has_ai_access %}
                    <button type="button" class="btn-ai-generate" id="btnAiGenerate" onclick="regenerateWithAI()">
                        <span>‚ú®</span> R√©g√©n√©rer avec l'IA
                    </button>
                    {% else %}
                    <button type="button" class="btn-ai-generate ai-tooltip" disabled data-tooltip="Fonctionnalit√© r√©serv√©e aux abonn√©s">
                        <span>‚ú®</span> R√©g√©n√©rer avec l'IA
                    </button>
                    {% endif %}
                    <button class="btn btn-primary" onclick="openAddModal()">Ajouter un service</button>
                </div>
            </div>

            <div id="servicesTable">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <div class="admin-preview-section">
        <p class="preview-title">Aper√ßu mobile - Services</p>
        <div class="mini-iphone">
            <div class="iphone-notch"></div>
            <div class="iphone-screen">
                <div class="status-bar">
                    <span>Infos Pratiques</span>
                </div>
                <div class="app-content">
                    <div class="preview-content">
                        <div class="preview-section-title">Services √† proximit√©</div>

                        <div id="preview-services">
                            <div class="preview-card">
                                <div class="preview-row">
                                    <span class="preview-row-icon">üíä</span>
                                    <div class="preview-row-content">
                                        <strong>Pharmacie du Rh√¥ne</strong>
                                        <small>Place du Champ de Mars</small>
                                    </div>
                                </div>
                                <div class="preview-row">
                                    <span class="preview-row-icon">üè•</span>
                                    <div class="preview-row-content">
                                        <strong>Maison de Sant√©</strong>
                                        <small>Avenue Paul Lafargue</small>
                                    </div>
                                </div>
                                <div class="preview-row">
                                    <span class="preview-row-icon">üõí</span>
                                    <div class="preview-row-content">
                                        <strong>Intermarch√©</strong>
                                        <small>ZAC des Faysses</small>
                                    </div>
                                </div>
                                <div class="preview-row">
                                    <span class="preview-row-icon">ü•ñ</span>
                                    <div class="preview-row-content">
                                        <strong>Boulangerie</strong>
                                        <small>Place du Champ de Mars</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="preview-card" style="background: #eff6ff; margin-top: 12px;">
                            <div class="preview-card-header">
                                <span>üí°</span>
                                <strong>Conseil</strong>
                            </div>
                            <p>Tous les commerces essentiels sont accessibles √† pied depuis le mazet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Add/Edit Service -->
<div id="serviceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Ajouter un service</h3>
            <button class="modal-close" onclick="closeModal('serviceModal')">&times;</button>
        </div>

        <form id="serviceForm">
            <input type="hidden" id="service_id" name="id">

            <div class="form-group">
                <label class="form-label" for="name">Nom du service</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="category">Cat√©gorie</label>
                <div class="category-row">
                    <select class="form-control" id="category" name="category" required onchange="onCategoryChange()">
                        <option value="">S√©lectionnez une cat√©gorie</option>
                        <option value="pharmacy">üíä Pharmacie</option>
                        <option value="doctor">üè• M√©decin</option>
                        <option value="supermarket">üõí Supermarch√©</option>
                        <option value="bakery">ü•ñ Boulangerie</option>
                        <option value="restaurant">üçΩÔ∏è Restaurant</option>
                        <option value="bank">üè¶ Banque</option>
                        <option value="gas_station">‚õΩ Station essence</option>
                        <option value="post">üì´ Poste</option>
                        <option value="other">üìç Autre</option>
                    </select>
                    {% if has_ai_access %}
                    <button type="button" class="btn-ai-search" id="btnAiSearch" onclick="findServiceWithAI()" disabled title="Rechercher le service le plus proche">
                        <span>‚ú®</span> Rechercher
                    </button>
                    {% else %}
                    <button type="button" class="btn-ai-search ai-tooltip" disabled data-tooltip="Fonctionnalit√© r√©serv√©e aux abonn√©s">
                        <span>‚ú®</span> Rechercher
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="icon">Ic√¥ne personnalis√©e (optionnel)</label>
                <div class="emoji-input-wrapper">
                    <input type="text" class="form-control emoji-input" id="icon" name="icon" readonly placeholder="Par d√©faut selon cat√©gorie">
                    <button type="button" class="emoji-trigger" id="iconTrigger" onclick="openEmojiPicker('icon', this)">üìç</button>
                </div>
                <small style="color: #9ca3af; font-size: 0.75rem;">Laissez vide pour utiliser l'ic√¥ne de la cat√©gorie</small>
            </div>

            <div class="form-group">
                <label class="form-label" for="address">Adresse</label>
                <textarea class="form-control" id="address" name="address" rows="2" required></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" for="phone">T√©l√©phone</label>
                <input type="tel" class="form-control" id="phone" name="phone">
            </div>

            <div class="form-group">
                <label class="form-label" for="description">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" for="opening_hours">Horaires d'ouverture</label>
                <input type="text" class="form-control" id="opening_hours" name="opening_hours" placeholder="Lun-Sam: 8h-19h">
            </div>

            <div class="form-group">
                <label class="form-label" for="display_order">Ordre d'affichage</label>
                <input type="number" class="form-control" id="display_order" name="display_order" value="0">
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('serviceModal')">Annuler</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/emoji-picker.js') }}"></script>
<script>
let services = [];

const categoryIcons = {
    'pharmacy': 'üíä',
    'doctor': 'üè•',
    'supermarket': 'üõí',
    'bakery': 'ü•ñ',
    'restaurant': 'üçΩÔ∏è',
    'bank': 'üè¶',
    'gas_station': '‚õΩ',
    'post': 'üì´',
    'other': 'üìç'
};

function updateCategoryIcon() {
    const category = document.getElementById('category').value;
    const iconTrigger = document.getElementById('iconTrigger');
    const iconInput = document.getElementById('icon');

    // Only update if icon field is empty
    if (!iconInput.value && iconTrigger) {
        iconTrigger.textContent = categoryIcons[category] || 'üìç';
    }
}

function onCategoryChange() {
    updateCategoryIcon();

    // Enable/disable AI search button based on category
    const category = document.getElementById('category').value;
    const btnAiSearch = document.getElementById('btnAiSearch');
    if (btnAiSearch) {
        // Enable if a valid category is selected (not empty and not 'other')
        btnAiSearch.disabled = !category || category === 'other';
    }
}

async function findServiceWithAI() {
    const category = document.getElementById('category').value;
    if (!category || category === 'other') return;

    const btn = document.getElementById('btnAiSearch');
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Recherche...';

    try {
        const response = await fetch('/api/ai/find-service', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Property-ID': localStorage.getItem('locapp_current_property')
            },
            body: JSON.stringify({ category: category })
        });

        const result = await response.json();

        if (response.ok && result.service) {
            // Fill the form with the found service data
            const service = result.service;
            document.getElementById('name').value = service.name || '';
            document.getElementById('address').value = service.address || '';
            document.getElementById('phone').value = service.phone || '';
            document.getElementById('opening_hours').value = service.opening_hours || '';

            // Add distance info to description
            if (service.distance) {
                document.getElementById('description').value = `√Ä ${service.distance} de la propri√©t√©`;
            }

            showAlert(result.message, 'success');
        } else {
            showAlert(result.error || 'Aucun service trouv√©', 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
        onCategoryChange(); // Re-check if button should stay enabled
    }
}

async function loadServices() {
    try {
        services = await fetchAPI('/api/services');
        renderServices();
        updatePreview();
    } catch (error) {
        showAlert('Erreur lors du chargement des services', 'error');
    }
}

function updatePreview() {
    const previewContainer = document.getElementById('preview-services');

    if (services.length === 0) {
        previewContainer.innerHTML = '<p style="text-align: center; font-size: 9px; color: #9ca3af;">Aucun service configur√©</p>';
        return;
    }

    let html = '<div class="preview-card">';
    services.slice(0, 5).forEach(service => {
        const icon = service.icon || categoryIcons[service.category] || 'üìç';
        html += `
            <div class="preview-row">
                <span class="preview-row-icon">${icon}</span>
                <div class="preview-row-content">
                    <strong>${service.name}</strong>
                    <small>${service.address ? service.address.split(',')[0] : ''}</small>
                </div>
            </div>
        `;
    });
    html += '</div>';

    previewContainer.innerHTML = html;
}

function renderServices() {
    const container = document.getElementById('servicesTable');

    if (services.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üè™</div>
                <div class="empty-state-text">Aucun service</div>
            </div>
        `;
        return;
    }

    let html = `
        <table class="table" id="servicesTableBody">
            <thead>
                <tr>
                    <th style="width: 40px;"></th>
                    <th>Nom</th>
                    <th>Cat√©gorie</th>
                    <th>Adresse</th>
                    <th>T√©l√©phone</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

    services.forEach(service => {
        const icon = service.icon || categoryIcons[service.category] || 'üìç';
        html += `
            <tr data-service-id="${service.id}" draggable="true">
                <td class="drag-handle" title="Glisser pour r√©ordonner">‚ãÆ‚ãÆ</td>
                <td>${icon} ${service.name}</td>
                <td><span class="badge badge-primary">${service.category}</span></td>
                <td>${service.address || '-'}</td>
                <td>${service.phone || '-'}</td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-icon btn-secondary" onclick="editService(${service.id})" title="Modifier">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-icon btn-danger" onclick="deleteService(${service.id})" title="Supprimer">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    container.innerHTML = html;
    initDragAndDrop();
}

// Drag and Drop functionality
let draggedRow = null;

function initDragAndDrop() {
    const rows = document.querySelectorAll('#servicesTableBody tbody tr');
    rows.forEach(row => {
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('dragleave', handleDragLeave);
        row.addEventListener('drop', handleDrop);
    });
}

function handleDragStart(e) {
    draggedRow = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    draggedRow = null;
    // Remove all drag-over classes
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function handleDragOver(e) {
    e.preventDefault();
    if (!draggedRow || draggedRow === this) return;
    this.classList.add('drag-over');
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');

    if (!draggedRow || draggedRow === this) return;

    const tbody = this.parentNode;
    const rows = [...tbody.querySelectorAll('tr')];
    const draggedIndex = rows.indexOf(draggedRow);
    const dropIndex = rows.indexOf(this);

    if (draggedIndex < dropIndex) {
        tbody.insertBefore(draggedRow, this.nextSibling);
    } else {
        tbody.insertBefore(draggedRow, this);
    }

    saveServiceOrder();
}

async function saveServiceOrder() {
    const rows = document.querySelectorAll('#servicesTableBody tbody tr');
    const serviceIds = [...rows].map(row => parseInt(row.dataset.serviceId));

    // Update local array order
    const newServices = serviceIds.map(id => services.find(s => s.id === id));
    services.splice(0, services.length, ...newServices);

    // Update preview
    updatePreview();

    // Save to server
    const propertyId = getCurrentPropertyId();
    try {
        await fetch(`/api/services/reorder?property_id=${propertyId}`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({ service_ids: serviceIds })
        });
    } catch (error) {
        console.error('Error saving order:', error);
        showAlert('Erreur lors de la sauvegarde de l\'ordre', 'error');
    }
}

function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Ajouter un service';
    document.getElementById('serviceForm').reset();
    document.getElementById('service_id').value = '';

    // Reset icon trigger
    const iconTrigger = document.getElementById('iconTrigger');
    if (iconTrigger) {
        iconTrigger.textContent = 'üìç';
    }

    // Reset AI search button (disabled until category selected)
    const btnAiSearch = document.getElementById('btnAiSearch');
    if (btnAiSearch) {
        btnAiSearch.disabled = true;
    }

    openModal('serviceModal');
}

async function editService(id) {
    const service = services.find(s => s.id === id);
    if (!service) return;

    document.getElementById('modalTitle').textContent = 'Modifier le service';
    document.getElementById('service_id').value = service.id;
    loadDataIntoForm(service, 'serviceForm');

    // Update icon trigger
    const iconTrigger = document.getElementById('iconTrigger');
    if (iconTrigger) {
        iconTrigger.textContent = service.icon || categoryIcons[service.category] || 'üìç';
    }

    // Update AI search button state based on category
    const btnAiSearch = document.getElementById('btnAiSearch');
    if (btnAiSearch) {
        btnAiSearch.disabled = !service.category || service.category === 'other';
    }

    openModal('serviceModal');
}

async function deleteService(id) {
    if (!confirmAction('√ätes-vous s√ªr de vouloir supprimer ce service ?')) {
        return;
    }

    const headers = getAuthHeaders();
    if (!headers) return;

    try {
        const response = await fetch(`/api/services/${id}`, {
            method: 'DELETE',
            headers: headers
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message, 'success');
            loadServices();
        } else {
            showAlert('Erreur: ' + (result.error || '√âchec de la suppression'), 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    }
}

document.getElementById('serviceForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const headers = getAuthHeaders();
    if (!headers) return;

    const formData = getFormData('serviceForm');
    const serviceId = document.getElementById('service_id').value;
    const propertyId = getCurrentPropertyId();

    const url = serviceId
        ? `/api/services/${serviceId}?property_id=${propertyId}`
        : `/api/services?property_id=${propertyId}`;
    const method = serviceId ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            headers: headers,
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message, 'success');
            closeModal('serviceModal');
            loadServices();
        } else {
            showAlert('Erreur: ' + (result.error || '√âchec de l\'op√©ration'), 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    }
});

// AI Regeneration
async function regenerateWithAI() {
    if (!confirmAction('R√©g√©n√©rer tous les services avec l\'IA ? Les services existants seront remplac√©s.')) return;

    const btn = document.getElementById('btnAiGenerate');
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> G√©n√©ration...';

    try {
        const response = await fetch('/api/ai/regenerate/services', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Property-ID': localStorage.getItem('locapp_current_property')
            }
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('Services r√©g√©n√©r√©s avec succ√®s !', 'success');
            loadServices();
        } else {
            showAlert(result.error || 'Erreur lors de la r√©g√©n√©ration', 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
    }
}

loadServices();
</script>
{% endblock %}
