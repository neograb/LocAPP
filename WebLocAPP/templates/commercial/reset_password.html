{% extends "commercial/base_commercial.html" %}

{% block title %}Réinitialiser le mot de passe - LocAPP{% endblock %}

{% block content %}
<div class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            {% if error %}
            <!-- Error State -->
            <div style="text-align: center; padding: 2rem 0;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">⚠️</div>
                <h2 style="color: var(--text-dark); margin-bottom: 1rem;">Lien invalide</h2>
                <p style="color: var(--text-light); margin-bottom: 2rem;">
                    {{ error }}
                </p>
                <div style="margin-top: 2rem;">
                    <a href="{{ url_for('forgot_password_page') }}" class="btn btn-primary">Demander un nouveau lien</a>
                </div>
            </div>
            {% elif token %}
            <div class="auth-header">
                <h1>Nouveau mot de passe</h1>
                <p>Définissez un nouveau mot de passe pour <strong>{{ email }}</strong></p>
            </div>

            <form id="resetPasswordForm" class="auth-form active" onsubmit="handleResetPassword(event)">
                <div class="form-group">
                    <label class="form-label" for="password">Nouveau mot de passe</label>
                    <input type="password" class="form-control" id="password" name="password" required placeholder="••••••••" minlength="8">
                    <small style="color: var(--text-light); font-size: 0.75rem;">Minimum 8 caractères</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password-confirm">Confirmer le mot de passe</label>
                    <input type="password" class="form-control" id="password-confirm" name="password_confirm" required placeholder="••••••••">
                </div>

                <div id="alertContainer"></div>

                <input type="hidden" id="token" value="{{ token }}">

                <div class="form-submit">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Réinitialiser le mot de passe</button>
                </div>
            </form>

            <!-- Success State -->
            <div id="successState" style="display: none; text-align: center; padding: 2rem 0;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">✅</div>
                <h2 style="color: var(--text-dark); margin-bottom: 1rem;">Mot de passe modifié !</h2>
                <p style="color: var(--text-light); margin-bottom: 2rem;">
                    Votre mot de passe a été réinitialisé avec succès. Vous pouvez maintenant vous connecter avec votre nouveau mot de passe.
                </p>
                <div style="margin-top: 2rem;">
                    <a href="{{ url_for('login') }}" class="btn btn-primary">Se connecter</a>
                </div>
            </div>
            {% endif %}
        </div>

        <p style="text-align: center; margin-top: 2rem; color: var(--text-light);">
            <a href="{{ url_for('commercial_home') }}" style="color: var(--primary-color);">← Retour à l'accueil</a>
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function handleResetPassword(event) {
    event.preventDefault();

    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('password-confirm').value;
    const token = document.getElementById('token').value;
    const submitBtn = document.getElementById('submitBtn');
    const alertContainer = document.getElementById('alertContainer');

    // Validate passwords match
    if (password !== passwordConfirm) {
        alertContainer.innerHTML = '<div class="alert alert-error">Les mots de passe ne correspondent pas</div>';
        return;
    }

    // Validate password length
    if (password.length < 8) {
        alertContainer.innerHTML = '<div class="alert alert-error">Le mot de passe doit contenir au moins 8 caractères</div>';
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Modification en cours...';
    alertContainer.innerHTML = '';

    try {
        const response = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token, password })
        });

        const result = await response.json();

        if (response.ok) {
            // Show success state
            document.getElementById('resetPasswordForm').style.display = 'none';
            document.getElementById('successState').style.display = 'block';
        } else {
            alertContainer.innerHTML = `<div class="alert alert-error">${result.error || 'Une erreur est survenue'}</div>`;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Réinitialiser le mot de passe';
        }
    } catch (error) {
        alertContainer.innerHTML = '<div class="alert alert-error">Erreur de connexion au serveur</div>';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Réinitialiser le mot de passe';
    }
}
</script>
{% endblock %}
