{% extends "base.html" %}

{% block title %}Contact - Administration LocApp{% endblock %}

{% block content %}
<div class="admin-layout">
    <div class="admin-form-section">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Informations de Contact</h2>
            </div>

            <!-- Avatar Section -->
            <div class="avatar-section">
                <label class="form-label">Photo de profil</label>
                <div class="avatar-container">
                    <div class="avatar-preview" id="avatarPreview">
                        <img id="avatarImage" src="/static/images/default-avatar.svg" alt="Avatar">
                        <div class="avatar-overlay" onclick="document.getElementById('avatarInput').click()">
                            <span>üì∑</span>
                        </div>
                    </div>
                    <div class="avatar-actions">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('avatarInput').click()">Changer</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteAvatar()" id="deleteAvatarBtn" style="display: none;">Supprimer</button>
                    </div>
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="uploadAvatar(this.files[0])">
                </div>
                <p class="form-hint">Formats accept√©s: PNG, JPG, JPEG, GIF, WEBP (max 16 MB)</p>
            </div>

            <form id="contactForm">
                <div class="form-group">
                    <label class="form-label" for="host_name">Nom de l'h√¥te</label>
                    <input type="text" class="form-control" id="host_name" name="host_name" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="phone">T√©l√©phone</label>
                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="+33688461607" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="whatsapp">WhatsApp</label>
                    <input type="text" class="form-control" id="whatsapp" name="whatsapp" placeholder="33688461607">
                </div>

                <div class="form-group">
                    <label class="form-label" for="airbnb_url">URL Airbnb</label>
                    <input type="url" class="form-control" id="airbnb_url" name="airbnb_url">
                </div>

                <div class="form-group">
                    <label class="form-label" for="description">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="2" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="response_time">Temps de r√©ponse</label>
                    <input type="text" class="form-control" id="response_time" name="response_time" placeholder="Je r√©ponds g√©n√©ralement dans l'heure">
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" onclick="loadData()">Annuler</button>
                </div>
            </form>

            <div class="info-box" style="margin-top: 2rem;">
                <strong>Derni√®re modification:</strong> <span id="lastUpdate">-</span>
            </div>
        </div>
    </div>

    <div class="admin-preview-section">
        <p class="preview-title">Aper√ßu mobile - Contact</p>
        <div class="mini-iphone">
            <div class="iphone-notch"></div>
            <div class="iphone-screen">
                <div class="status-bar">
                    <span>Contact</span>
                </div>
                <div class="app-content">
                    <div class="preview-content">
                        <div style="text-align: center; margin-bottom: 16px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #fed7aa 0%, #fef08a 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; overflow: hidden;">
                                <img id="preview-avatar" src="/static/images/default-avatar.svg" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <strong style="font-size: 12px;" id="preview-name">Votre h√¥te</strong>
                            <p style="font-size: 8px; color: #6b7280;" id="preview-desc">√Ä votre service pour un s√©jour parfait</p>
                        </div>

                        <div class="preview-contact-btn">
                            <span class="preview-contact-icon green">üìû</span>
                            <div class="preview-contact-text">
                                <strong>Appeler</strong>
                                <small id="preview-phone">+33688461607</small>
                            </div>
                        </div>

                        <div class="preview-contact-btn">
                            <span class="preview-contact-icon blue">üí¨</span>
                            <div class="preview-contact-text">
                                <strong>SMS / WhatsApp</strong>
                                <small id="preview-whatsapp">Disponible 7j/7</small>
                            </div>
                        </div>

                        <div class="preview-contact-btn">
                            <span class="preview-contact-icon orange">‚úâÔ∏è</span>
                            <div class="preview-contact-text">
                                <strong>Email</strong>
                                <small id="preview-email">solex07700@gmail.com</small>
                            </div>
                        </div>

                        <div class="preview-card" style="background: #fef2f2; margin-top: 12px; text-align: center;">
                            <span style="font-size: 16px;">üè†</span>
                            <p style="font-size: 10px; color: #b91c1c; margin-top: 4px;"><strong>Messagerie Airbnb</strong></p>
                            <p style="font-size: 8px; color: #ef4444;" id="preview-response">Je r√©ponds g√©n√©ralement dans l'heure</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.avatar-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.avatar-container {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 0.5rem;
}

.avatar-preview {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    background: linear-gradient(135deg, #fed7aa 0%, #fef08a 100%);
    cursor: pointer;
}

.avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.avatar-preview:hover .avatar-overlay {
    opacity: 1;
}

.avatar-overlay span {
    font-size: 24px;
}

.avatar-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.85rem;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.form-hint {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
}
</style>
<script>
let currentAvatarPath = null;

function updatePreview() {
    document.getElementById('preview-name').textContent = document.getElementById('host_name').value || 'Votre h√¥te';
    document.getElementById('preview-phone').textContent = document.getElementById('phone').value || 'T√©l√©phone';
    document.getElementById('preview-email').textContent = document.getElementById('email').value || 'Email';
    document.getElementById('preview-whatsapp').textContent = document.getElementById('whatsapp').value ? 'Disponible 7j/7' : 'Non configur√©';
    document.getElementById('preview-desc').textContent = document.getElementById('description').value || '';
    document.getElementById('preview-response').textContent = document.getElementById('response_time').value || '';
}

document.querySelectorAll('#contactForm input, #contactForm textarea').forEach(input => {
    input.addEventListener('input', updatePreview);
});

async function loadData() {
    try {
        const data = await fetchAPI('/api/contact');
        loadDataIntoForm(data, 'contactForm');
        document.getElementById('lastUpdate').textContent = formatDate(data.updated_at);

        // Load avatar
        if (data.avatar) {
            currentAvatarPath = data.avatar;
            const avatarUrl = `/static/uploads/photos/${data.avatar}`;
            document.getElementById('avatarImage').src = avatarUrl;
            document.getElementById('preview-avatar').src = avatarUrl;
            document.getElementById('deleteAvatarBtn').style.display = 'block';
        } else {
            currentAvatarPath = null;
            document.getElementById('avatarImage').src = '/static/images/default-avatar.svg';
            document.getElementById('preview-avatar').src = '/static/images/default-avatar.svg';
            document.getElementById('deleteAvatarBtn').style.display = 'none';
        }

        updatePreview();
    } catch (error) {
        showAlert('Erreur lors du chargement des donn√©es', 'error');
    }
}

async function uploadAvatar(file) {
    if (!file) return;

    const propertyId = getCurrentPropertyId();
    if (!propertyId) {
        showAlert('Veuillez s√©lectionner une propri√©t√©', 'error');
        return;
    }

    if (!file.type.startsWith('image/')) {
        showAlert('Le fichier doit √™tre une image', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('avatar', file);

    try {
        const response = await fetch(`/api/contact/avatar?property_id=${propertyId}`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            currentAvatarPath = result.avatar;
            const avatarUrl = `/static/uploads/photos/${result.avatar}`;
            document.getElementById('avatarImage').src = avatarUrl;
            document.getElementById('preview-avatar').src = avatarUrl;
            document.getElementById('deleteAvatarBtn').style.display = 'block';
            showAlert('Avatar mis √† jour', 'success');
        } else {
            showAlert(`Erreur: ${result.error}`, 'error');
        }
    } catch (error) {
        showAlert('Erreur lors de l\'upload de l\'avatar', 'error');
    }

    // Reset file input
    document.getElementById('avatarInput').value = '';
}

async function deleteAvatar() {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer l\'avatar ?')) return;

    const propertyId = getCurrentPropertyId();
    if (!propertyId) {
        showAlert('Veuillez s√©lectionner une propri√©t√©', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/contact/avatar?property_id=${propertyId}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });

        const result = await response.json();

        if (response.ok) {
            currentAvatarPath = null;
            document.getElementById('avatarImage').src = '/static/images/default-avatar.svg';
            document.getElementById('preview-avatar').src = '/static/images/default-avatar.svg';
            document.getElementById('deleteAvatarBtn').style.display = 'none';
            showAlert('Avatar supprim√©', 'success');
        } else {
            showAlert(`Erreur: ${result.error}`, 'error');
        }
    } catch (error) {
        showAlert('Erreur lors de la suppression de l\'avatar', 'error');
    }
}

document.getElementById('contactForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const headers = getAuthHeaders();
    if (!headers) return;

    const formData = getFormData('contactForm');

    try {
        const propertyId = getCurrentPropertyId();
        const response = await fetch(`/api/contact?property_id=${propertyId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message, 'success');
            loadData();
        } else {
            showAlert('Erreur: ' + (result.error || '√âchec de la mise √† jour'), 'error');
        }
    } catch (error) {
        showAlert('Erreur de connexion', 'error');
    }
});

loadData();
</script>
{% endblock %}
