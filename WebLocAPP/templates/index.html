{% extends "base.html" %}

{% block title %}Accueil - Administration LocApp{% endblock %}

{% block content %}
<div class="simulator-page">
    <div class="simulator-header">
        <h1>Aper√ßu de l'application</h1>
        <p>Visualisez l'application mobile telle que vos locataires la verront</p>
    </div>

    <div class="simulator-container">
        <!-- iPhone Frame -->
        <div class="iphone-frame">
            <!-- Notch -->
            <div class="iphone-notch"></div>

            <!-- Screen -->
            <div class="iphone-screen">
                <!-- Status Bar -->
                <div class="status-bar">
                    <span id="status-title">Accueil</span>
                </div>

                <!-- Content Area -->
                <div class="app-content">
                    <!-- Accueil Tab -->
                    <div id="tab-accueil" class="tab-content active">
                        <div class="app-header-card">
                            <div class="header-decoration">
                                <span class="deco-icon top-right">üåø</span>
                                <span class="deco-icon bottom-left">üèõÔ∏è</span>
                            </div>
                            <span class="header-icon">üè°</span>
                            <span class="header-title" id="property-name">Le Mazet de BSA</span>
                            <span class="header-subtitle" id="property-location">Bourg-Saint-And√©ol ‚Ä¢ Ard√®che</span>
                        </div>

                        <div class="welcome-section">
                            <h1>Bienvenue ! üåø</h1>
                            <p id="welcome-message">Nous sommes ravis de vous accueillir dans notre Mazet.</p>
                        </div>

                        <div class="info-card">
                            <div class="info-card-header">
                                <span>‚ú®</span>
                                <span>Votre petit coin de paradis</span>
                            </div>
                            <p id="property-description">En plein c≈ìur de Bourg-Saint-And√©ol, notre mazet saura vous charmer avec ses vieilles pierres et ses poutres apparentes.</p>
                            <div class="tags">
                                <span class="tag">üèõÔ∏è Pierres</span>
                                <span class="tag">üìè Poutres</span>
                                <span class="tag">‚ù§Ô∏è Charme</span>
                            </div>
                        </div>

                        <div class="section">
                            <h3>Acc√®s rapide</h3>
                            <div class="quick-access-grid">
                                <div class="quick-item blue">
                                    <img src="/static/images/wifi-icon.svg" alt="WiFi" style="width: 24px; height: 24px; filter: invert(1);">
                                    <strong>WiFi</strong>
                                    <small>Code & connexion</small>
                                </div>
                                <div class="quick-item green">
                                    <span>üìç</span>
                                    <strong>Adresse</strong>
                                    <small id="address-info">Centre-ville BSA</small>
                                </div>
                                <div class="quick-item red">
                                    <span>üì∑</span>
                                    <strong>Photos</strong>
                                    <small>Galerie</small>
                                </div>
                                <div class="quick-item orange">
                                    <span>üÜò</span>
                                    <strong>Urgences</strong>
                                    <small>Num√©ros utiles</small>
                                </div>
                            </div>
                        </div>

                        <div class="section">
                            <h3>√Ä d√©couvrir</h3>
                            <div class="discover-scroll" id="highlights-list">
                                <div class="discover-item">
                                    <span>üèûÔ∏è</span>
                                    <strong>Gorges</strong>
                                    <small>15 min</small>
                                </div>
                                <div class="discover-item">
                                    <span>üåâ</span>
                                    <strong>Pont d'Arc</strong>
                                    <small>20 min</small>
                                </div>
                                <div class="discover-item">
                                    <span>ü¶¥</span>
                                    <strong>Grotte Chauvet</strong>
                                    <small>25 min</small>
                                </div>
                                <div class="discover-item">
                                    <span>üêä</span>
                                    <strong>Crocodiles</strong>
                                    <small>15 min</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Infos Tab -->
                    <div id="tab-infos" class="tab-content">
                        <div class="info-section">
                            <h4>Connexion Internet</h4>
                            <div class="info-list">
                                <div class="info-row">
                                    <span class="info-icon"><img src="/static/images/wifi-icon.svg" alt="WiFi" style="width: 20px; height: 20px;"></span>
                                    <div class="info-text">
                                        <strong>WiFi</strong>
                                        <small id="wifi-name">R√©seau & mot de passe</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                            </div>
                        </div>

                        <div class="info-section">
                            <h4>Acc√®s au Mazet</h4>
                            <div class="info-list">
                                <div class="info-row">
                                    <span class="info-icon">üìç</span>
                                    <div class="info-text">
                                        <strong>Adresse</strong>
                                        <small id="address-info">Centre-ville de BSA</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                                <div class="info-row border">
                                    <span class="info-icon">üöó</span>
                                    <div class="info-text">
                                        <strong>Parking</strong>
                                        <small id="parking-detail">Gratuit √† 150m</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                                <div class="info-row border">
                                    <span class="info-icon">üîë</span>
                                    <div class="info-text">
                                        <strong>Cl√©s & Acc√®s</strong>
                                        <small id="access-info">Arriv√©e / D√©part</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                            </div>
                        </div>

                        <div class="info-section">
                            <h4>√âquipements</h4>
                            <div class="info-list">
                                <div class="info-row">
                                    <span class="info-icon">üõèÔ∏è</span>
                                    <div class="info-text">
                                        <strong>Literie</strong>
                                        <small>Lits faits √† l'arriv√©e</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                                <div class="info-row border">
                                    <span class="info-icon">üöø</span>
                                    <div class="info-text">
                                        <strong>Serviettes</strong>
                                        <small>Fournies</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                                <div class="info-row border">
                                    <span class="info-icon">üç≥</span>
                                    <div class="info-text">
                                        <strong>Cuisine</strong>
                                        <small>Tout √©quip√©e</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                            </div>
                        </div>

                        <div class="info-section">
                            <h4>Urgences</h4>
                            <div class="info-list" id="emergency-list">
                                <div class="info-row">
                                    <span class="info-icon">üöë</span>
                                    <div class="info-text">
                                        <strong>SAMU</strong>
                                        <small>15</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                                <div class="info-row border">
                                    <span class="info-icon">üöí</span>
                                    <div class="info-text">
                                        <strong>Pompiers</strong>
                                        <small>18</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                                <div class="info-row border">
                                    <span class="info-icon">üëÆ</span>
                                    <div class="info-text">
                                        <strong>Police</strong>
                                        <small>17</small>
                                    </div>
                                    <span class="arrow">‚Ä∫</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activit√©s Tab -->
                    <div id="tab-activites" class="tab-content">
                        <div class="activities-header">
                            <h2>D√©couvrez l'Ard√®che üåø</h2>
                            <p>Nos recommandations autour de BSA</p>
                        </div>

                        <div id="activities-list">
                            <div class="activity-card">
                                <div class="activity-header">
                                    <span>‚≠ê</span>
                                    <strong>Incontournables</strong>
                                </div>
                                <div class="activity-tags">
                                    <span>Gorges de l'Ard√®che</span>
                                    <span>Pont d'Arc</span>
                                    <span>Grotte Chauvet</span>
                                </div>
                            </div>

                            <div class="activity-card">
                                <div class="activity-header">
                                    <span>üèä</span>
                                    <strong>Baignade & Kayak</strong>
                                </div>
                                <div class="activity-tags">
                                    <span>Descente en cano√´</span>
                                    <span>Plages de l'Ard√®che</span>
                                </div>
                            </div>

                            <div class="activity-card">
                                <div class="activity-header">
                                    <span>üèõÔ∏è</span>
                                    <strong>Villes √† visiter</strong>
                                </div>
                                <div class="activity-tags">
                                    <span>Mont√©limar</span>
                                    <span>Orange</span>
                                    <span>Avignon</span>
                                </div>
                            </div>

                            <div class="activity-card">
                                <div class="activity-header">
                                    <span>üß∫</span>
                                    <strong>March√©s</strong>
                                </div>
                                <div class="activity-tags">
                                    <span>BSA (samedi)</span>
                                    <span>Pierrelatte (mardi)</span>
                                </div>
                            </div>
                        </div>

                        <div class="specialties-card">
                            <p><strong>üçØ Sp√©cialit√©s √† go√ªter</strong></p>
                            <div class="specialty-tags">
                                <span>üßÄ Picodon</span>
                                <span>üç¨ Nougat</span>
                                <span>üå∞ Ch√¢taignes</span>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Tab -->
                    <div id="tab-contact" class="tab-content">
                        <div class="contact-avatar">
                            <div class="avatar-circle">
                                <span>üë§</span>
                            </div>
                            <h2>Votre h√¥te</h2>
                            <p>√Ä votre service pour un s√©jour parfait</p>
                        </div>

                        <div class="contact-buttons" id="contact-buttons">
                            <div class="contact-btn">
                                <span class="contact-icon green">üìû</span>
                                <div class="contact-text">
                                    <strong>Appeler</strong>
                                    <small id="contact-phone">06 XX XX XX XX</small>
                                </div>
                                <span class="arrow">‚Ä∫</span>
                            </div>

                            <div class="contact-btn">
                                <span class="contact-icon blue">üí¨</span>
                                <div class="contact-text">
                                    <strong>SMS</strong>
                                    <small>R√©ponse rapide</small>
                                </div>
                                <span class="arrow">‚Ä∫</span>
                            </div>

                            <div class="contact-btn">
                                <span class="contact-icon whatsapp">üì±</span>
                                <div class="contact-text">
                                    <strong>WhatsApp</strong>
                                    <small>Disponible 7j/7</small>
                                </div>
                                <span class="arrow">‚Ä∫</span>
                            </div>

                            <div class="contact-btn">
                                <span class="contact-icon orange">‚úâÔ∏è</span>
                                <div class="contact-text">
                                    <strong>Email</strong>
                                    <small id="contact-email">votre@email.com</small>
                                </div>
                                <span class="arrow">‚Ä∫</span>
                            </div>
                        </div>

                        <div class="airbnb-card">
                            <span>üè†</span>
                            <p><strong>Messagerie Airbnb</strong></p>
                            <small>Contactez-nous aussi via l'app</small>
                        </div>

                        <div class="tip-card">
                            <span>üí°</span>
                            <p>Questions non urgentes ‚Üí SMS/WhatsApp<br>Urgences ‚Üí Appelez directement</p>
                        </div>
                    </div>
                </div>

                <!-- Tab Bar -->
                <div class="tab-bar">
                    <button class="tab-btn active" data-tab="accueil">
                        <span>üè†</span>
                        <small>Accueil</small>
                    </button>
                    <button class="tab-btn" data-tab="infos">
                        <span>‚ÑπÔ∏è</span>
                        <small>Infos</small>
                    </button>
                    <button class="tab-btn" data-tab="activites">
                        <span>‚≠ê</span>
                        <small>Activit√©s</small>
                    </button>
                    <button class="tab-btn" data-tab="contact">
                        <span>‚úâÔ∏è</span>
                        <small>Contact</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="export-section">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Export des donn√©es</h2>
            </div>
            <div class="info-box">
                <strong>Export JSON</strong> - Exportez toutes les donn√©es pour l'application iOS
            </div>
            <button onclick="downloadExport()" class="btn btn-success">T√©l√©charger l'export JSON</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tab navigation
const tabBtns = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const statusTitle = document.getElementById('status-title');

const tabTitles = {
    'accueil': 'Accueil',
    'infos': 'Infos Pratiques',
    'activites': 'Activit√©s',
    'contact': 'Contact'
};

tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;

        tabBtns.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
        statusTitle.textContent = tabTitles[tab];
    });
});

// Load data from API (named loadData for property selector compatibility)
async function loadData() {
    try {
        // Get current property ID and build URLs with property_id parameter
        const propertyId = getCurrentPropertyId();
        const addPropertyId = (url) => `${url}?property_id=${propertyId}`;

        const [general, wifi, address, parking, access, contact, activities, emergency] = await Promise.all([
            fetch(addPropertyId('/api/general')).then(r => r.json()).catch(() => ({})),
            fetch(addPropertyId('/api/wifi')).then(r => r.json()).catch(() => ({})),
            fetch(addPropertyId('/api/address')).then(r => r.json()).catch(() => ({})),
            fetch(addPropertyId('/api/parking')).then(r => r.json()).catch(() => ({})),
            fetch(addPropertyId('/api/access')).then(r => r.json()).catch(() => ({})),
            fetch(addPropertyId('/api/contact')).then(r => r.json()).catch(() => ({})),
            fetch(addPropertyId('/api/activities')).then(r => r.json()).catch(() => []),
            fetch(addPropertyId('/api/emergency')).then(r => r.json()).catch(() => [])
        ]);

        // Update general info
        if (general.property_name) {
            document.getElementById('property-name').textContent = general.property_name;
        }
        if (general.location) {
            document.getElementById('property-location').textContent = general.location;
        }
        if (general.welcome_message) {
            document.getElementById('welcome-message').textContent = general.welcome_message;
        }
        if (general.description) {
            document.getElementById('property-description').textContent = general.description;
        }

        // Update WiFi
        if (wifi.ssid) {
            document.getElementById('wifi-name').textContent = wifi.ssid;
        }

        // Update address
        if (address.street) {
            document.getElementById('address-info').textContent = address.street;
        }

        // Update parking
        if (parking.description) {
            document.getElementById('parking-info').textContent = parking.description;
            document.getElementById('parking-detail').textContent = parking.description;
        }

        // Update access
        if (access.check_in || access.check_out) {
            document.getElementById('access-info').textContent = `${access.check_in || '15h'} / ${access.check_out || '11h'}`;
        }

        // Update contact
        if (contact.phone) {
            document.getElementById('contact-phone').textContent = contact.phone;
        }
        if (contact.email) {
            document.getElementById('contact-email').textContent = contact.email;
        }

    } catch (error) {
        console.error('Error loading app data:', error);
    }
}

// Export function
function downloadExport() {
    const username = prompt('Nom d\'utilisateur:');
    const password = prompt('Mot de passe:');

    if (!username || !password) return;

    const propertyId = getCurrentPropertyId();
    fetch(`/api/export/download?property_id=${propertyId}`, {
        headers: {
            'Authorization': 'Basic ' + btoa(username + ':' + password)
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Authentification √©chou√©e');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'locapp_data.json';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showAlert('Export t√©l√©charg√© avec succ√®s', 'success');
    })
    .catch(error => {
        showAlert('Erreur: ' + error.message, 'error');
    });
}

// Load data on page load
loadData();
</script>
{% endblock %}
